# ImageMgr

一个强大的 Obsidian 图片管理插件，帮助您轻松管理和处理仓库中的图片文件。

> **注意**: 本插件目前处于开发阶段，版本号为 0.1.0。

## ✨ 功能特性

### 核心功能
- 📸 **智能扫描**: 自动扫描仓库中的所有图片文件（支持 PNG、JPG、GIF、WEBP、SVG、BMP 等格式）
- 🔍 **实时搜索**: 快速搜索和过滤图片，支持按文件名搜索
- ↕️ **灵活排序**: 按名称、大小、日期、尺寸等多种方式排序
- 🎯 **类型筛选**: 按图片类型筛选（PNG、JPG、GIF 等）
- 🏷️ **批量重命名**: 支持灵活的文件重命名模式（`{index}`、`{name}` 占位符）
- 📊 **详细信息**: 查看图片的完整信息（尺寸、大小、修改时间等）
- 🖼️ **图片预览**: 美观的网格布局图片预览界面
- 🖱️ **滚轮模式切换**: 在查看详情时支持滚轮切换图片或缩放图片
- 🖱️ **拖拽框选**: 类似文件夹的鼠标拖拽框选功能，快速选择多个图片
- ⚡ **性能优化**: 懒加载机制，支持大量图片的流畅浏览

### 高级功能 🆕
- 🔗 **图片引用查询**: 自动查找图片在笔记中的引用，支持 Markdown、HTML、Wiki 链接等多种格式
- 💾 **智能保存**: 只在实际有更改时提示保存，美观的自定义确认对话框
- 📜 **操作日志系统**: 专业的日志记录系统，基于图片哈希值追踪所有操作（重命名、移动、删除、旋转等）
  - 支持日志级别筛选（DEBUG、INFO、WARNING、ERROR）
  - 支持操作类型分类查看
  - 支持关键词搜索和导出
  - 图片详情页实时显示操作记录（每3秒自动刷新）
- 🗑️ **回收站功能**: 完善的图片回收站管理
  - 显示删除时间、文件大小、原始路径
  - 支持图片预览、批量选择、搜索排序
  - 双击查看图片详情（预览、MD5、操作记录可用，编辑功能禁用）
  - 支持恢复、永久删除、清空回收站
  - MD5 哈希值自动计算并缓存
- 🔄 **MD5去重**: 通过MD5哈希检测重复图片，避免重复存储（需在设置中启用）
- 📝 **智能重命名**: 根据引用笔记路径和图片序号自动生成命名
- 🔁 **批量操作**: 批量智能重命名，支持多引用处理策略
- 🏷️ **图片分组**: 按位置、类型、引用状态、锁定状态等多种方式分组，支持3种作用范围（所有图片、筛选结果、选中图片）
- 🈳 **空链接检测**: 检测笔记中指向不存在文件的图片链接
- 🈲 **文件保护**: 锁定列表功能，保护重要文件不被批量操作
  - 使用 MD5 哈希值作为主键，文件名作为辅键
  - 即使文件重命名或移动，锁定状态仍然保持
  - 只有哈希值和文件名都相同的文件才被视为重复
- ⚙️ **丰富配置**: 可配置扫描路径、每行图片数、默认排序、性能优化、UI主题等多达20+个选项

## 📖 使用说明

### 🚀 打开图片管理视图

有两种方式打开图片管理视图：

1. **侧边栏图标**: 点击左侧侧边栏的图片图标 📷
2. **命令面板**: 按 `Ctrl+P`（Mac: `Cmd+P`），输入"打开图片管理"并回车

### ⌨️ 快捷键

**当前已实现的快捷键**:
- **命令面板**: `Ctrl+P` (Mac: `Cmd+P`) → 输入"打开图片管理"
  - **图片详情页**:
    - **导航**: `←→↑↓` 切换图片，`Home/End` 第一张/最后一张，`Escape` 关闭
    - **预览**: `+/-` 缩放，`R/L` 旋转，`0` 重置，`F` 切换视图，`W` 切换滚轮模式
    - **编辑**: `Delete` 删除，`Ctrl/Cmd+S` 保存，`Ctrl/Cmd+L` 锁定/解锁
    - 输入框：`Ctrl/Cmd+Enter` 保存，`ArrowDown/Up` 导航建议，`Enter` 选择
    - **注意**: 在路径输入框中且自动补全建议列表显示时，`↑↓` 用于导航建议，不会切换图片
  - `Ctrl/Cmd + 滚轮`：强制缩放模式
- **图片管理视图**:
  - **视图**: `Ctrl/Cmd+F` 搜索，`Ctrl/Cmd+Shift+S` 排序，`Ctrl/Cmd+Shift+F` 筛选，`Ctrl/Cmd+G` 分组
  - **操作**: `Delete` 删除选中（智能处理输入框焦点），`Ctrl/Cmd+A` 全选，`Ctrl/Cmd+L` 锁定/解锁
  - **批量**: `Ctrl/Cmd+R` 重命名，`Ctrl/Cmd+Shift+D` 智能重命名
- **回收站**:
  - **操作**: `Delete` 永久删除选中，`R` 恢复选中，`Ctrl/Cmd+A` 全选/取消全选，`Esc` 关闭
  - **提示**: 界面底部显示快捷键提示栏
- **筛选模态框**: `ArrowDown/Up` 导航，`Enter` 选择，`Escape` 关闭
- **快捷键设置**: 在设置页面可以自定义所有快捷键，支持重置为默认值

**详细说明**: 查看本文档的"⌨️ 快捷键"部分了解完整的快捷键列表和使用说明

### 🔍 搜索和筛选

- **搜索**: 点击工具栏的"搜索"按钮，输入文件名进行搜索
- **排序**: 点击"排序"按钮，选择排序方式（名称、大小、日期、尺寸）和顺序（升序/降序）
- **筛选**: 点击"筛选"按钮，按图片类型筛选（PNG、JPG、GIF 等）

### 🖱️ 拖拽框选

在图片管理视图或回收站中快速选择多个图片：

1. **启动框选**: 在图片列表的空白区域按住鼠标左键并拖动
2. **选择图片**: 拖拽时会显示蓝色选择框，框内的图片自动被选中
3. **自动更新**: 选中的图片会高亮显示，复选框自动打勾
4. **批量操作**: 完成框选后可进行批量删除、重命名等操作

**智能避免冲突**:
- 点击复选框、按钮或输入框时不会启动框选
- 点击图片卡片时不会启动框选
- 只在容器空白区域有效

### 🏷️ 批量重命名

1. 在图片列表中点击选择要重命名的图片（支持多选）
2. 点击工具栏的"重命名"按钮
3. 输入命名格式，支持的占位符：
   - `{index}` - 自动编号（从 1 开始）
   - `{name}` - 原文件名
   - 示例：`image_{index}` → image_001.jpg, image_002.jpg...
   - 示例：`{name}_副本` → 在原文件名后添加"_副本"
4. 点击确定完成重命名

### 🖼️ 查看图片详情

1. **双击图片**或点击图片，打开详情模态框
2. 在详情页面可以：
   
   **编辑信息**:
   - **文件名**: 直接在输入框中编辑文件名（自动保护文件扩展名）
   - **路径**: 在输入框中修改文件路径（支持目录自动补全，最多显示4个匹配建议，输入框宽度已优化）
   - **📍 定位按钮**: 关闭详情页，在新标签页打开图片并定位到文件列表（静默操作，不显示提示）
   - **格式和大小**: 查看文件格式和大小（只读）
   - **位置保存/撤销按钮**: 修改路径后显示✅按钮，保存后显示↪️按钮可撤销更改
   
   **图片预览**（第一排）:
   - **放大** (+) / **缩小** (−): 调整图片显示大小（仅预览）
   - **逆时针旋转** (↺) / **顺时针旋转** (↻): 旋转图片并保存到文件
   - **还原** (⨯): 重置缩放预览效果
   
   **视图控制**（第二排）:
   - **滚轮模式切换** (🖱️): 在"切换图片"和"缩放图片"模式间切换
     - **切换模式**: 向上滚动切换到上一张，向下滚动切换到下一张
     - **缩放模式**: 向上滚动放大，向下滚动缩小
   - **适应窗口** (⛶): 在"适应窗口"和"1:1显示"间切换
   - **图片切换**: 使用 ◀▶ 按钮切换图片
   - **删除** (🗑️): 删除当前图片
   
   **保存和关闭**:
   - **保存** (💾): 保存文件名和路径的更改
   - **路径保存/撤销**: 
     - 修改路径后自动显示 **✅** 保存按钮
     - 点击✅后显示 **↪️** 撤销按钮
     - 点击↪️可撤销到上次保存的路径，自动删除创建的空文件夹
   - **关闭** (✕): 关闭详情页面
   - **未保存提示**: 如果修改了内容但未保存，关闭时会弹出提示：
     - **保存**: 保存更改后关闭
     - **放弃**: 丢弃更改并关闭
     - **取消** (右上角X): 返回继续编辑
   - **复制链接**: 点击复制 Markdown 或 HTML 链接到剪贴板
   - **打开文件**: 在 Obsidian 中打开原始文件
   
   **📜 操作记录**:
   - 基于图片MD5哈希值追踪所有操作
   - 显示详细的操作日志（时间、级别、操作类型、消息、详情、错误）
   - 实时自动刷新（每3秒）
   - 默认显示最近10条，可点击"查看更多"打开完整日志查看器
   - 支持颜色编码（INFO-蓝、WARNING-黄、ERROR-红）
   - 所有日志条目可选中复制

### 📊 库统计

点击"库统计"按钮查看整个图片库的统计信息，包括：
- 总图片数量
- 按类型分布
- 总大小
- 平均大小等

### 📋 日志系统

专业的插件操作日志系统：

**核心特性**:
- **基于哈希值追踪**: 使用图片MD5哈希值，即使重命名/移动也能追踪
- **分级记录**: DEBUG、INFO、WARNING、ERROR 四个级别
- **操作分类**: 扫描、重命名、移动、删除、旋转、批量操作、引用更新等15+种操作类型
- **详细信息**: 记录操作消息、图片路径、图片名称、操作详情、错误堆栈等
- **性能优化**: 生产环境默认不输出控制台日志，避免性能问题
- **级别控制**: 可配置最小日志级别，过滤低级别日志
- **开发友好**: 开发模式下自动输出ERROR和WARNING，方便调试

**查看方式**:
1. **图片详情页**: 实时显示该图片的操作记录（每3秒自动刷新）
2. **日志查看器**: 设置页面打开完整日志查看器
   - 支持按级别、操作类型筛选
   - 支持关键词搜索
   - 支持复制到剪贴板
   - 支持导出为文件
   - 显示统计信息

**使用场景**:
- 追踪某张图片的所有历史操作
- 查找错误和警告
- 审计批量操作结果
- 调试插件问题

**日志设置**:
- **日志级别**: 在设置中配置最小日志级别（DEBUG、INFO、WARNING、ERROR），默认 INFO
- **控制台输出**: 生产环境建议关闭，避免控制台日志过多（默认关闭）
- **DEBUG日志**: 调试时启用，生产环境建议关闭（默认关闭）
- 所有日志都会保存到插件数据中，可通过日志查看器查看，不受控制台设置影响
- 开发模式下，ERROR和WARNING会自动输出到控制台，方便调试

### 🆕 高级功能使用

#### MD5去重
1. 在设置中启用"MD5去重"
2. 点击"扫描"按钮
3. 如果发现重复图片，会显示提示信息
4. 所有图片的MD5哈希值用于日志追踪

#### 图片预览
1. 打开图片详情页
2. 使用放大/缩小、旋转按钮预览图片
3. **注意**: 预览效果仅用于查看，不会保存到文件
4. 关闭窗口后所有预览效果自动丢弃

#### 查看操作日志
1. **方式一**: 在图片详情页查看该图片的操作记录（自动刷新）
2. **方式二**: 在设置页面点击"📊 打开日志查看器"
3. 可筛选级别、操作类型，搜索关键词
4. 可复制或导出日志

### 🔁 批量智能重命名

根据引用笔记路径和图片序号智能重命名：

1. 点击工具栏的"智能重命名"按钮 🔁
2. 选择作用范围（所有图片/筛选结果/选中图片）
3. 自动查找每张图片的引用笔记
4. 根据笔记路径和图片序号生成命名（例如：`笔记路径_1.png`）
5. 自动更新所有笔记中的引用链接
6. 生成详细的批量命名日志（可选）

**特点**:
- 📍 **基于引用**: 根据引用笔记的路径命名，而非图片自身路径
- 🔢 **序号编号**: 在笔记中的第几张图就编号为几
- 🔄 **多引用处理**: 支持"使用第一个引用"、"使用最新笔记"、"每次提示"、"为每个创建副本"
- 🈲 **文件保护**: 锁定的文件不会被重命名
- 📝 **操作日志**: 所有操作记录到日志系统

**进度显示** 🆕：
- 批量操作时会显示进度条和当前处理的文件信息
- 可通过设置中的"显示批量进度"选项启用/禁用
- 进度显示在操作完成后自动移除

### 🈳 空链接检测

快速检测笔记中指向不存在文件的图片链接：

1. 点击工具栏的"空链接"按钮 🈳
2. 查看所有空链接列表
3. 点击"前往笔记"快速定位并修复

### 🗑️ 回收站管理

完善的回收站功能，安全管理已删除的图片：

**打开回收站**：
1. 点击工具栏的"回收站"按钮 🗑️
2. 查看所有已删除的图片

**主要功能**：
- **图片卡片显示**：
  - 图片预览（自适应宽高比）
  - 文件名和原始路径
  - 删除时间（具体日期时间）
  - 文件大小
  - 右上角复选框选择

- **批量操作**：
  - 单击卡片/复选框：选择/取消选择
  - 全选按钮：一键选择所有文件
  - 批量恢复：将选中文件恢复到原位置
  - 批量删除：永久删除选中文件
  - 清空回收站：删除所有文件

- **查看详情**：
  - 双击图片打开详情页
  - 支持功能：图片预览、缩放、旋转、MD5查看、操作记录
  - 禁用功能：重命名、移动、查看引用（需先恢复文件）

- **MD5 哈希**：
  - 首次打开详情时自动计算 MD5
  - 自动缓存，下次打开立即显示
  - 即使文件被删除，仍可追踪图片历史

- **搜索和排序**：
  - 支持按文件名搜索
  - 支持按时间、大小排序
  - 统计信息实时更新

**注意事项**：
- 回收站文件路径为 `.trash/时间戳_原文件名`
- 恢复文件时自动移除时间戳前缀
- 永久删除操作不可恢复，请谨慎操作
- 详情页的编辑功能需要先恢复文件后才可使用

### ⚙️ 设置配置

在 **设置 → 图片管理** 中可以配置：

#### 基础设置
- **自动扫描**: 启动时自动扫描图片
- **默认图片文件夹**: 设置扫描的默认路径（留空则扫描整个仓库）
- **包含子文件夹**: 是否扫描子文件夹中的图片

#### 重命名设置 🆕
- **多引用处理**: 当一张图片被多个笔记引用时的处理策略
  - 使用第一个引用的笔记
  - 使用最新修改的笔记
  - 每次提示选择
  - 为每个笔记创建副本
- **保存批量重命名日志**: 是否生成详细的命名记录文件
- **锁定文件**: 管理被锁定保护的文件列表

#### 显示设置
- **每行图片数**: 设置画廊模式下每行显示的图片数量（2-8）
- **默认排序方式**: 设置打开时的默认排序
- **默认排序顺序**: 升序或降序
- **默认筛选类型**: 设置打开时的默认筛选类型

#### 图片处理 🆕
- **MD5去重**: 启用后扫描时计算并检测重复图片，哈希值用于日志追踪
- **自动生成文件名**: 根据笔记标题自动生成序列文件名
- **鼠标滚轮模式**: 在图片详情页中，当鼠标位于图片上时滚轮的默认行为（切换图片/缩放图片）
- **图片编辑**: 支持旋转（90度、180度、270度）、翻转（水平、垂直）和尺寸调整，操作后自动保存

#### 性能优化 🆕
- **启用懒加载**: 延迟加载图片，提升大量图片时的性能
- **懒加载延迟**: 延迟加载的等待时间（毫秒）
- **最大缓存大小**: 图片缓存的最大数量

#### UI主题 🆕
- **卡片圆角**: 图片卡片的圆角半径
- **卡片间距**: 图片卡片之间的间距
- **固定图片高度**: 设置固定的图片显示高度
- **启用悬停效果**: 鼠标悬停时的动画效果
- **显示图片索引**: 在卡片上显示图片序号

#### 删除行为 🆕
- **删除前确认**: 删除文件前显示确认对话框
- **移至系统回收站**: 删除文件时移至系统回收站而非永久删除（推荐开启，可恢复）

#### 搜索功能 🆕
- **区分大小写**: 搜索时是否区分大小写
- **实时搜索延迟**: 输入后延迟搜索的时间（毫秒）
- **搜索路径**: 是否在文件路径中搜索

#### 批量操作 🆕
- **最大批量操作数**: 一次批量操作的最大文件数
- **批量确认阈值**: 超过此数量时显示确认对话框
- **显示批量进度**: 批量操作时显示进度条（✅ 已优化）
  - 批量智能重命名支持实时进度显示
  - 显示进度条、当前处理的文件信息
  - 进度显示在操作完成后自动移除

#### 统计信息 🆕
- **显示统计信息**: 在界面中显示统计信息
- **统计位置**: 统计信息的显示位置（顶部/底部）

#### 操作日志 🆕
- **日志级别**: DEBUG、INFO、WARNING、ERROR（设置记录的最小日志级别）
- **输出到控制台**: 是否将日志输出到浏览器控制台（生产环境建议关闭，默认关闭）
- **启用DEBUG日志**: 是否记录DEBUG级别的日志（调试时启用，默认关闭）
- **查看操作日志**: 打开日志查看器，支持筛选、搜索、复制和导出
- **清除所有日志**: 删除所有操作日志记录（不可恢复）
- **特点**: 统一使用 Logger 系统，生产环境默认不输出控制台日志，避免性能问题

#### 引用设置
- **保持详情页打开**: 点击"前往笔记"时保持详情页打开
- **显示引用时间**: 在引用信息区域显示笔记文件的最后修改时间

## 📦 安装

### 方式一：快速安装（仅需3个文件）⭐ 推荐

这是最简单的安装方式，**无需任何编译工具**。

#### 步骤：

1. **下载插件文件**
   - 从 [GitHub 仓库](https://github.com/Coeicy/imagemgr) 的 Releases 页面下载以下3个文件：
     - `main.js` - 编译后的插件代码
     - `manifest.json` - 插件配置文件
     - `styles.css` - 插件样式文件

2. **创建插件目录**
   - 打开你的 Obsidian 仓库文件夹
   - 进入 `.obsidian/plugins/` 目录
   - 创建新文件夹 `imagemgr`

3. **复制文件**
   - 将下载的3个文件复制到 `imagemgr` 文件夹中
   - 文件结构应该如下：
   ```
   .obsidian/
   └── plugins/
       └── imagemgr/
           ├── main.js
           ├── manifest.json
           └── styles.css
   ```

4. **启用插件**
   - 重新打开 Obsidian（或按 `Ctrl+R` 重新加载）
   - 进入 **设置 → 社区插件 → 已安装的插件**
   - 找到 "ImageMgr" 并启用它
   - 点击左侧侧边栏的图片图标 📷 打开插件

#### 验证安装成功：
- ✅ 左侧侧边栏出现图片图标 📷
- ✅ 命令面板中可以搜索到 "打开图片管理" 命令
- ✅ 设置中有 "图片管理" 选项卡

---

### 方式二：从源代码构建（开发版）

如果你想修改代码或参与开发：

1. 下载或克隆项目到本地
2. 运行 `npm install` 安装依赖
3. 运行 `npm run build` 构建插件
4. 复制生成的 `main.js`、`manifest.json` 和 `styles.css` 到你的仓库 `.obsidian/plugins/imagemgr/` 目录
5. 重新加载 Obsidian
6. 在 **设置 → 社区插件** 中启用插件

---

### 方式三：社区插件市场（待发布）

待插件稳定后，将发布到 Obsidian 社区插件市场，届时可直接在 Obsidian 中搜索安装。

## 🛠️ 开发

### 环境要求

- Node.js 18+（推荐使用 LTS 版本）
- npm（项目使用 npm 作为包管理器）
- Obsidian（用于测试插件）

### 快速开始

```bash
# 克隆项目
git clone <仓库地址>
cd imagemgr

# 安装依赖
npm install

# 开发模式（自动监听文件变化并重新编译）
npm run dev

# 生产构建
npm run build
```

### 开发流程

1. **启动开发模式**: 运行 `npm run dev`，这会启动 esbuild 的监听模式
   - 开发服务器会监听 `src/` 目录的文件变化
   - 文件保存后会自动编译到 `main.js`
   - 控制台会显示 `[watch] 构建完成，监听文件变化...` 表示监听已启动
2. **修改代码**: 在 `src/` 目录下修改 TypeScript 代码
3. **自动编译**: 文件保存后会自动编译到 `main.js`
4. **重新加载插件**: 在 Obsidian 中按 `Ctrl+R`（Mac: `Cmd+R`）重新加载插件
5. **测试功能**: 验证修改是否正常工作

**开发模式特点**:
- 自动监听文件变化，无需手动重新编译
- 支持 TypeScript 类型检查
- 编译错误会在控制台显示
- 开发完成后运行 `npm run build` 进行生产构建

### 代码风格检查

```bash
# 全局安装 eslint（如果还未安装）
npm install -g eslint

# 检查代码风格
eslint ./src/
```

### 项目依赖

**生产依赖**:
- **spark-md5** (^3.0.2): MD5哈希计算库，用于图片去重和日志追踪

**开发依赖**:
- **esbuild** (0.17.3): 快速的 JavaScript 打包和构建工具
- **obsidian** (最新版): Obsidian API 类型定义和核心库
- **typescript** (4.7.4): TypeScript 编译器和类型系统
- **tslib** (2.4.0): TypeScript 运行时库
- **@typescript-eslint/parser** (5.29.0): TypeScript ESLint 解析器
- **@typescript-eslint/eslint-plugin** (5.29.0): TypeScript ESLint 规则
- **@types/node** (^16.11.6): Node.js 类型定义
- **@types/spark-md5** (^3.0.5): spark-md5 类型定义
- **builtin-modules** (3.3.0): Node.js 内置模块列表

**技术实现**:
- **HTML5 Canvas 接口**: 浏览器原生图片处理（编辑、旋转、翻转）
- **TypeScript 严格模式**: 严格的类型检查，确保代码质量
- **异步处理**: 使用 async/await 处理文件操作和 I/O
- **事件驱动**: 使用 Obsidian 事件系统监听文件变化
- **模块化架构**: 清晰的代码组织和依赖管理

## 📁 项目结构

```
imagemgr/
├── src/                          # 源代码目录
│   ├── main.ts                   # 插件入口点，生命周期管理
│   ├── settings.ts               # 设置接口和默认值
│   ├── types.ts                  # TypeScript 类型定义
│   ├── constants.ts              # 常量配置（UI尺寸、时间、限制等）
│   ├── ui/                       # UI 组件
│   │   ├── image-manager-view.ts    # 主视图 - 图片管理界面
│   │   ├── settings-tab.ts          # 设置标签页
│   │   ├── image-detail-modal.ts    # 图片详情模态框
│   │   ├── confirm-modal.ts         # 自定义确认对话框
│   │   ├── group-modal.ts           # 分组模态框
│   │   ├── broken-links-modal.ts    # 空链接检测模态框
│   │   ├── duplicate-detection-modal.ts  # 重复检测模态框
│   │   ├── log-viewer-modal.ts      # 日志查看器模态框
│   │   ├── rename-modal.ts          # 重命名模态框
│   │   ├── search-modal.ts          # 搜索模态框
│   │   ├── sort-modal.ts            # 排序模态框
│   │   ├── filter-modal.ts          # 筛选模态框
│   │   ├── stats-modal.ts           # 统计模态框
│   │   ├── trash-modal.ts           # 回收站模态框
│   │   └── components/              # UI 子组件
│   │       ├── image-preview-panel.ts   # 图片预览面板
│   │       ├── image-controls-panel.ts  # 图片控制面板
│   │       └── image-history-panel.ts   # 操作记录面板
│   └── utils/                    # 工具函数
│       ├── logger.ts             # 日志管理器
│       ├── reference-manager.ts  # 引用管理器（Wiki/Markdown/HTML解析）
│       ├── image-processor.ts    # 图片处理工具
│       ├── image-hash.ts         # MD5哈希计算
│       ├── image-scanner.ts      # 图片扫描器
│       ├── hash-cache-manager.ts  # 哈希缓存管理器
│       ├── history-manager.ts    # 历史记录管理
│       ├── error-handler.ts      # 统一错误处理
│       ├── path-validator.ts     # 路径验证
│       ├── file-filter.ts        # 文件过滤
│       ├── file-edit-service.ts  # 文件编辑服务
│       ├── reference-edit-service.ts # 引用编辑服务
│       ├── trash-manager.ts      # 回收站管理器
│       ├── trash-formatter.ts    # 回收站格式化器
│       ├── trash-path-parser.ts  # 回收站路径解析器
│       ├── keyboard-shortcut-manager.ts # 快捷键管理器
│       ├── lock-list-manager.ts  # 锁定列表管理器
│       ├── image-optimizer.ts    # 图片优化器
│       └── resizable-modal.ts    # 可调整大小的模态框基类
├── main.js                       # 编译后的插件文件
├── manifest.json                 # 插件清单文件
├── styles.css                    # 样式文件
├── package.json                  # npm 配置文件
├── tsconfig.json                 # TypeScript 配置
├── esbuild.config.mjs            # esbuild 构建配置
├── versions.json                 # 版本映射文件
├── version-bump.mjs              # 版本更新脚本
├── README.md                     # 用户文档（本文件）
├── .gitignore                    # Git 忽略文件列表
├── .eslintrc                     # ESLint 配置
├── .editorconfig                 # 编辑器配置
└── data.json                     # 插件数据文件（日志、缓存等，运行时生成）
```

### 文件说明

#### 核心文件
- **main.ts**: 插件生命周期管理，注册视图、命令和设置，处理文件变化监听
- **settings.ts**: 定义插件设置接口和默认值
- **types.ts**: 定义图片信息、设置和历史记录的类型
- **constants.ts**: 集中管理所有常量（UI尺寸、时间配置、数量限制等）

#### UI 组件
- **image-manager-view.ts**: 主视图，负责图片列表展示和用户交互
- **image-detail-modal.ts**: 图片详情页，提供预览、编辑、引用管理等功能
- **settings-tab.ts**: 设置页面，提供14个设置分组
- **confirm-modal.ts**: 自定义确认对话框（支持2-3个按钮）
- **group-modal.ts**: 图片分组功能（5种分组方式，3种作用范围）
- **broken-links-modal.ts**: 空链接检测和修复
- **duplicate-detection-modal.ts**: 重复图片检测和管理
- **log-viewer-modal.ts**: 日志查看器（筛选、搜索、导出）
- **其他模态框**: 搜索、排序、筛选、统计、重命名、引用选择等

#### UI 子组件
- **image-preview-panel.ts**: 图片预览面板（缩放、旋转、拖拽）
- **image-controls-panel.ts**: 图片控制按钮面板
- **image-history-panel.ts**: 操作记录面板（实时刷新）

#### 工具模块
- **logger.ts**: 专业日志管理系统（基于MD5哈希追踪）
- **reference-manager.ts**: 引用管理器（解析Wiki/Markdown/HTML链接）
- **image-processor.ts**: 图片处理工具（尺寸、格式等）
- **image-hash.ts**: MD5哈希计算（用于去重和日志追踪）
- **image-scanner.ts**: 图片扫描器（递归扫描指定目录）
- **image-optimizer.ts**: 图片编辑（旋转、翻转，使用Canvas API）
- **hash-cache-manager.ts**: 哈希值缓存管理
- **history-manager.ts**: 历史记录管理（重命名、移动、删除等）
- **error-handler.ts**: 统一错误处理和提示
- **path-validator.ts**: 路径验证和规范化
- **file-filter.ts**: 文件过滤（锁定列表检查）
- **lock-list-manager.ts**: 锁定列表管理（MD5哈希+文件名双键）
- **file-edit-service.ts**: 文件编辑服务（重命名、移动、删除）
- **reference-edit-service.ts**: 引用编辑服务（更新笔记中的图片链接）
- **trash-manager.ts**: 回收站管理（删除、恢复、清空）
- **trash-formatter.ts**: 回收站格式化（时间戳处理）
- **trash-path-parser.ts**: 回收站路径解析
- **keyboard-shortcut-manager.ts**: 快捷键管理和自定义

## 🎯 设计特点

- **模块化架构**: 代码组织清晰，易于维护和扩展
- **响应式设计**: 适配不同窗口大小，提供流畅的用户体验
- **性能优化**: 懒加载和批量渲染机制，支持处理大量图片
- **用户友好**: 丰富的交互提示和直观的操作界面
- **类型安全**: 使用 TypeScript 确保代码质量
- **离线优先**: 所有操作在本地完成，无需网络连接

## 🚀 快速开始

### 第一次使用

1. **安装插件**: 按照上述安装步骤完成插件安装
2. **启用插件**: 在设置 → 社区插件中启用插件
3. **打开视图**: 点击侧边栏的图片图标或使用命令面板
4. **配置设置**: 根据需要调整设置中的参数

### 推荐配置

- **每行图片数**: 4-6 张（根据屏幕大小调整）
- **默认排序**: 按修改日期降序（查看最新的图片）
- **MD5去重**: 首次使用建议启用，清理重复图片

## ❓ 常见问题

### Q: 扫描速度很慢怎么办？
A: MD5去重功能会计算文件哈希值，可能较慢。可以在设置中暂时禁用。建议在首次扫描后定期使用。

### Q: 图片详情页的旋转会保存吗？
A: 是的。在图片详情页点击旋转按钮后，会立即保存到文件。预览模式的缩放和拖拽仅用于查看，不会保存。

### Q: 如何编辑图片（旋转保存）？
A: 图片详情页支持旋转和翻转功能，操作后会自动保存到文件。当前支持：
- 顺时针/逆时针旋转（90度、180度、270度）
- 水平/垂直翻转
- 尺寸调整

如需其他编辑功能（如裁剪、亮度调整等），请使用专业的图片编辑软件。

### Q: 如何在笔记中引用图片？
A: 在图片详情页面，直接点击 Markdown 或 HTML 链接即可复制到剪贴板，然后粘贴到笔记中。

### Q: 操作日志保存在哪里？
A: 保存在 Obsidian 的插件数据目录中（`.obsidian/plugins/imagemgr/data.json`），最多保存1000条日志。

### Q: 如何撤销路径修改？
A: 在图片详情页，修改路径并点击✅保存后，会出现↪️撤销按钮。点击可恢复到上次保存的路径，并自动删除创建的空文件夹。

### Q: 路径输入框如何使用？
A: 在图片详情页的位置输入框：
- 直接输入文件夹路径（如：`images/2024`）
- 输入时会显示匹配的建议，最多4个
- 使用↑↓方向键选择，Enter确认
- 如果目录不存在，会自动创建
- 支持键盘导航和鼠标点击选择

## 🐛 问题反馈

如果您在使用过程中遇到问题或有功能建议，请：

1. 检查是否是最新版本
2. 查看本文档了解详细功能和使用说明
3. 查看 [功能清单](功能清单.md) 了解所有功能
4. 查看 [开发者文档](开发者文档.md) 了解技术细节和开发流程
5. 提交问题报告或拉取请求

**常见问题排查**:
- 确保 Node.js 版本 >= 18
- 确保已运行 `npm install` 安装依赖
- 开发模式下，修改代码后需要在 Obsidian 中按 `Ctrl+R` 重新加载插件
- 如果编译出错，检查控制台输出的错误信息

## 📝 版本历史

### 0.1.0 (当前版本)

#### 核心功能
- ✨ 支持图片扫描、搜索、排序、筛选
- ✅ 支持批量重命名
- ✅ 支持图片详情查看和编辑
- ✅ 支持库统计功能
- ✅ 可配置的扫描路径和显示选项
- 🔁 批量路径命名功能
- 🈳 空链接检测功能

#### 高级功能 🆕
- 🔄 MD5去重检测重复图片
- 🔄 图片编辑（旋转、翻转、尺寸调整）并自动保存
- 📝 自动生成序列文件名
- 🔗 图片引用查询，支持多种链接格式
- 📜 操作日志系统（基于MD5哈希追踪）
- 💾 智能保存提示（只在实际有更改时提示）
- 🎨 美观的自定义确认对话框
- 🈲 文件保护（忽略列表）
- 🔄 重名处理策略（提示、跳过、使用最新/最旧）
- ⚙️ 设置联动更新功能
- ⌨️ 完整的键盘快捷键支持（支持自定义）

#### 修复与优化 🛠️
- 🐛 修复单行多图片引用解析错误（支持 `![[img1]] ![[img2]]` 同行显示）
- ♻️ 优化文本变化检测性能（引入防抖机制，减少不必要的扫描）
- ✨ 回收站图片恢复时完整保留并迁移历史操作记录

#### UI/UX 优化
- ✅ 图片自适应显示，不被按钮遮挡
- ✅ 操作按钮和历史记录固定在底部
- ✅ 鼠标滚轮模式可配置（切换图片/缩放图片）
- ✅ 忽略文件快速标记按钮（⚪/🈲）
- ✅ 批量命名日志自动生成
- ✅ 设置页面分组优化（所有设置项默认展开，快捷键设置上移）
- ✅ 路径输入框自动补全（最多显示4个匹配建议）
- ✅ 保存/撤销按钮（✅/↪️）
- ✅ 保存提示优化（分行显示旧→新路径）
- ✅ 撤销功能（恢复到上次保存位置，删除空文件夹）
- ✅ 完整的键盘快捷键支持（图片详情页和管理视图，支持自定义）
- ✅ 操作记录卡片间距优化（更紧凑的显示）

## 🤝 贡献指南

欢迎提交问题报告和拉取请求！

**开发流程**:
1. 复刻本仓库
2. 创建功能分支 (`git checkout -b feature/新功能`)
3. 提交更改 (`git commit -m '添加新功能'`)
4. 推送到分支 (`git push origin feature/新功能`)
5. 开启拉取请求

**代码规范**:
- 遵循 TypeScript 严格模式
- 运行 `eslint ./src/` 检查代码风格
- 为新功能添加注释和类型定义
- 更新相关文档

## 📄 许可证

MIT 许可证 - 详见 [LICENSE](LICENSE) 文件
