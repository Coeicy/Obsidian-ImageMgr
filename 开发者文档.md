# 开发者文档

为开发者提供的详细技术文档和开发指南。

## 项目概述

**ImageMgr** 是一个强大的 Obsidian 图片管理插件，提供完整的图片管理、编辑和追踪功能。

### 技术栈
- **框架**: Obsidian Plugin API
- **语言**: TypeScript
- **构建工具**: esbuild
- **包管理**: npm
- **代码检查**: ESLint
- **类型检查**: TypeScript Strict Mode

### 项目结构
```
imagemgr/
├── src/                    # 源代码
│   ├── main.ts            # 插件入口
│   ├── settings.ts        # 设置定义
│   ├── types.ts           # 类型定义
│   ├── constants.ts       # 常量配置
│   ├── ui/                # UI 组件
│   └── utils/             # 工具函数
├── main.js                # 编译后的文件
├── manifest.json          # 插件清单
├── styles.css             # 样式文件
└── package.json           # 依赖配置
```

## 开发环境设置

### 环境要求
- Node.js 18+ (推荐使用 LTS 版本)
- npm (项目使用 npm 作为包管理器)
- Obsidian (用于测试插件)

### 快速开始
```bash
# 1. 克隆项目
git clone <仓库地址>
cd imagemgr

# 2. 安装依赖
npm install

# 3. 启动开发模式
npm run dev

# 4. 生产构建
npm run build
```

### 开发工作流
1. 运行 `npm run dev` 启动监听模式
2. 在 `src/` 目录修改代码
3. 文件保存后自动编译
4. 在 Obsidian 中按 `Ctrl+R` 重新加载插件
5. 测试修改是否正常工作

## 核心模块说明

### main.ts - 插件入口
- 插件生命周期管理 (onload, onunload)
- 视图注册和命令注册
- 事件监听器设置（包含防抖机制优化）
- 设置加载和保存
- 核心管理器初始化 (Logger, ErrorHandler, ReferenceManager, TrashManager, HistoryManager)

**关键方法**:
- `onload()` - 插件加载时执行
- `onunload()` - 插件卸载时执行
- `activateView()` - 激活图片管理视图
- `loadSettings()` - 加载设置

### settings.ts - 设置管理
- 定义所有可配置的设置项
- 设置默认值
- 设置接口定义

**主要设置类别**:
- 基础设置 (自动扫描、默认文件夹等)
- 显示设置 (每行图片数、排序方式等)
- 性能设置 (懒加载、缓存等)
- UI 主题设置 (圆角、间距等)
- 日志设置 (日志级别、输出等)

### types.ts - 类型定义
定义项目中使用的所有 TypeScript 类型和接口。

**主要类型**:
- `ImageInfo` - 图片信息
- `ImageManagerSettings` - 设置接口
- `OperationLog` - 操作日志
- `TrashItem` - 回收站项目

### constants.ts - 常量配置
集中管理所有常量值。

**包含内容**:
- UI 尺寸常量
- 时间配置
- 数量限制
- 默认值

## UI 组件开发

### 主视图 (image-manager-view.ts)
负责图片列表展示和用户交互。

**主要功能**:
- 图片扫描和加载
- 网格布局展示
- 搜索、排序、筛选
- 快捷键处理
- 批量操作

### 详情模态框 (image-detail-modal.ts)
显示图片详细信息和编辑功能。

**主要功能**:
- 图片预览
- 文件名编辑
- 路径修改
- 引用查询
- 操作记录显示

### 其他模态框
- `search-modal.ts` - 搜索功能
- `sort-modal.ts` - 排序选择
- `filter-modal.ts` - 筛选选择
- `group-modal.ts` - 分组选择
- `rename-modal.ts` - 重命名
- `stats-modal.ts` - 统计信息
- `log-viewer-modal.ts` - 日志查看
- `trash-modal.ts` - 回收站管理

## 工具模块开发

### logger.ts - 日志管理
专业的日志记录系统。

**主要功能**:
- 基于 MD5 哈希值追踪
- 多级别日志 (DEBUG, INFO, WARNING, ERROR)
- 日志筛选和搜索
- 日志导出

**使用示例**:
```typescript
await this.logger.info(OperationType.RENAME, '重命名成功', {
  oldName: 'old.jpg',
  newName: 'new.jpg'
});
```

### image-scanner.ts - 图片扫描
扫描指定目录中的所有图片文件。

**主要功能**:
- 递归扫描目录
- 文件类型过滤
- 进度报告
- 错误处理

### reference-manager.ts - 引用管理
查找和管理图片的引用。

**支持的格式**:
- Markdown 链接: `![alt](path)`
- HTML 图片: `<img src="path">`
- Wiki 链接: `![[path]]`

### image-hash.ts - MD5 哈希
计算图片的 MD5 哈希值。

**主要功能**:
- 计算文件哈希
- 哈希缓存管理
- 重复检测

### trash-manager.ts - 回收站管理
管理已删除的文件。

**主要功能**:
- 删除文件到回收站
- 恢复文件
- 永久删除
- 清空回收站

### lock-list-manager.ts - 锁定列表管理
管理和监控锁定文件列表。

**主要功能**:
- 管理锁定文件列表的持久化存储
- 监控文件系统变化，实时更新锁定列表
- 处理文件删除、移动等操作对锁定列表的影响
- 提供锁定列表的查询和更新接口

**关键方法**:
- `addLockedFile(fileName, filePath, md5)` - 添加锁定文件（支持重复检测）
- `removeLockedFile(fileName, md5)` - 移除锁定文件
- `removeLockedFileBatch(items)` - 批量移除锁定文件
- `isFileLockedByNameOrHash(fileName, md5)` - 检查文件是否被锁定
- `clearAllLockedFiles()` - 清空所有锁定文件
- `getStatistics()` - 获取锁定列表统计信息

**重复文件识别机制**:
- 哈希值优先 - 相同 MD5 的文件只记录一次
- 文件名去重 - 相同文件名不重复添加
- 加载时去重 - 从 settings 加载时自动跳过重复项
- Key 格式 - `hash:${md5}` 或 `name:${fileName}`

## 代码规范

### TypeScript 规范
- 使用严格模式 (`strict: true`)
- 为所有函数添加类型注解
- 使用接口定义对象类型
- 避免使用 `any` 类型

### 命名规范
- 类名: PascalCase (如 `ImageManagerView`)
- 函数名: camelCase (如 `scanImages`)
- 常量名: UPPER_SNAKE_CASE (如 `MAX_CACHE_SIZE`)
- 私有属性: 前缀 `_` (如 `_cache`)

### 注释规范
- 为公开方法添加 JSDoc 注释
- 为复杂逻辑添加行注释
- 保持注释简洁明了

### 错误处理
- 使用 try-catch 处理异步操作
- 使用 ErrorHandler 统一处理错误
- 为用户提供有意义的错误提示

## 测试指南

### 单元测试
```bash
# 运行测试
npm test

# 运行特定测试
npm test -- --testNamePattern="图片扫描"

# 生成覆盖率报告
npm test -- --coverage
```

### 集成测试
1. 在 Obsidian 中加载插件
2. 执行各项功能操作
3. 检查日志输出
4. 验证结果正确性

### 性能测试
- 测试大量图片 (1000+) 的加载性能
- 测试搜索和排序性能
- 测试内存占用

## 调试技巧

### 启用调试日志
在设置中启用 DEBUG 日志级别，查看详细的调试信息。

### 使用浏览器开发者工具
1. 在 Obsidian 中按 `Ctrl+Shift+I` 打开开发者工具
2. 查看控制台输出
3. 检查网络请求
4. 调试 JavaScript 代码

### 常见问题排查
- **编译错误**: 检查 TypeScript 类型错误
- **运行时错误**: 查看浏览器控制台
- **性能问题**: 使用性能分析工具
- **内存泄漏**: 检查事件监听器是否正确清理

## 发布流程

### 版本管理
使用语义化版本 (Semantic Versioning):
- MAJOR: 不兼容的 API 更改
- MINOR: 向后兼容的新功能
- PATCH: 向后兼容的 bug 修复

### 发布步骤
1. 更新 `manifest.json` 中的版本号
2. 更新 `package.json` 中的版本号
3. 运行 `npm run build` 进行生产构建
4. 提交代码到仓库
5. 创建 Git tag: `git tag v0.1.0`
6. 推送到仓库: `git push origin v0.1.0`

## 贡献指南

### 开发流程
1. Fork 本仓库
2. 创建功能分支: `git checkout -b feature/新功能`
3. 提交更改: `git commit -m '添加新功能'`
4. 推送到分支: `git push origin feature/新功能`
5. 开启拉取请求

### 代码审查
- 遵循代码规范
- 添加必要的注释
- 更新相关文档
- 通过所有测试

### 提交信息规范
```
<type>(<scope>): <subject>

<body>

<footer>
```

类型:
- `feat`: 新功能
- `fix`: bug 修复
- `docs`: 文档更新
- `style`: 代码风格
- `refactor`: 代码重构
- `perf`: 性能优化
- `test`: 测试相关

## 资源链接

- [Obsidian Plugin API](https://docs.obsidian.md/Plugins/Getting+started/Build+a+plugin)
- [TypeScript 文档](https://www.typescriptlang.org/)
- [esbuild 文档](https://esbuild.github.io/)
- [ESLint 文档](https://eslint.org/)

---

**最后更新**: 2025-11-27 21:52 UTC+08:00
